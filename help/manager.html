<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
        "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="generator" content="AsciiDoc 8.5.2"/>
<title>Documentation technique du manageur de Jacinthe</title>
<style type="text/css">
/* Debug borders */
p, li, dt, dd, div, pre, h1, h2, h3, h4, h5, h6 {
    /*
      border: 1px solid red;
    */
}

body {
    margin: 1em 5% 1em 5%;
}

a {
    color: blue;
    text-decoration: underline;
}
a:visited {
    color: fuchsia;
}

em {
    font-style: italic;
    color: navy;
}

strong {
    font-weight: bold;
    color: #083194;
}

tt {
    color: navy;
}

h1, h2, h3, h4, h5, h6 {
    color: #527bbd;
    font-family: sans-serif;
    margin-top: 1.2em;
    margin-bottom: 0.5em;
    line-height: 1.3;
}

h1, h2, h3 {
    border-bottom: 2px solid silver;
}
h2 {
    padding-top: 0.5em;
}
h3 {
    float: left;
}
h3 + * {
    clear: left;
}

div.sectionbody {
    font-family: serif;
    margin-left: 0;
}

hr {
    border: 1px solid silver;
}

p {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
}

ul, ol, li > p {
    margin-top: 0;
}

pre {
    padding: 0;
    margin: 0;
}

span#author {
    color: #527bbd;
    font-family: sans-serif;
    font-weight: bold;
    font-size: 1.1em;
}
span#email {
}
span#revnumber, span#revdate, span#revremark {
    font-family: sans-serif;
}

div#footer {
    font-family: sans-serif;
    font-size: small;
    border-top: 2px solid silver;
    padding-top: 0.5em;
    margin-top: 4.0em;
}
div#footer-text {
    float: left;
    padding-bottom: 0.5em;
}
div#footer-badges {
    float: right;
    padding-bottom: 0.5em;
}

div#preamble {
    margin-top: 1.5em;
    margin-bottom: 1.5em;
}
div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
    margin-top: 1.0em;
    margin-bottom: 1.5em;
}
div.admonitionblock {
    margin-top: 2.0em;
    margin-bottom: 2.0em;
    margin-right: 10%;
    color: #606060;
}

div.content {
    /* Block element content. */
    padding: 0;
}

/* Block element titles. */
div.title, caption.title {
    color: #527bbd;
    font-family: sans-serif;
    font-weight: bold;
    text-align: left;
    margin-top: 1.0em;
    margin-bottom: 0.5em;
}
div.title + * {
    margin-top: 0;
}

td div.title:first-child {
    margin-top: 0.0em;
}
div.content div.title:first-child {
    margin-top: 0.0em;
}
div.content + div.title {
    margin-top: 0.0em;
}

div.sidebarblock > div.content {
    background: #ffffee;
    border: 1px solid silver;
    padding: 0.5em;
}

div.listingblock > div.content {
    border: 1px solid silver;
    background: #f4f4f4;
    padding: 0.5em;
}

div.quoteblock, div.verseblock {
    padding-left: 1.0em;
    margin-left: 1.0em;
    margin-right: 10%;
    border-left: 5px solid #dddddd;
    color: #777777;
}

div.quoteblock > div.attribution {
    padding-top: 0.5em;
    text-align: right;
}

div.verseblock > div.content {
    white-space: pre;
}
div.verseblock > div.attribution {
    padding-top: 0.75em;
    text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
    text-align: left;
}

div.admonitionblock .icon {
    vertical-align: top;
    font-size: 1.1em;
    font-weight: bold;
    text-decoration: underline;
    color: #527bbd;
    padding-right: 0.5em;
}
div.admonitionblock td.content {
    padding-left: 0.5em;
    border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
    border-left: 3px solid #dddddd;
    padding-left: 0.5em;
}

div.imageblock div.content {
    padding-left: 0;
}

span.image img {
    border-style: none;
}

a.image:visited {
    color: white;
}

dl {
    margin-top: 0.8em;
    margin-bottom: 0.8em;
}
dt {
    margin-top: 0.5em;
    margin-bottom: 0;
    font-style: normal;
    color: navy;
}
dd > *:first-child {
    margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
    list-style-type: decimal;
}
ol.loweralpha {
    list-style-type: lower-alpha;
}
ol.upperalpha {
    list-style-type: upper-alpha;
}
ol.lowerroman {
    list-style-type: lower-roman;
}
ol.upperroman {
    list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
    margin-top: 0.1em;
    margin-bottom: 0.1em;
}

div.tableblock > table {
    border: 3px solid #527bbd;
}
thead, p.table.header {
    font-family: sans-serif;
    font-weight: bold;
}
tfoot {
    font-weight: bold;
}
td > div.verse {
    white-space: pre;
}
p.table {
    margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
    border-style: none;
}
div.tableblock > table[frame="hsides"] {
    border-left-style: none;
    border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
    border-top-style: none;
    border-bottom-style: none;
}


div.hdlist {
    margin-top: 0.8em;
    margin-bottom: 0.8em;
}
div.hdlist tr {
    padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
    font-weight: bold;
}
td.hdlist1 {
    vertical-align: top;
    font-style: normal;
    padding-right: 0.8em;
    color: navy;
}
td.hdlist2 {
    vertical-align: top;
}
div.hdlist.compact tr {
    margin: 0;
    padding-bottom: 0;
}

.comment {
    background: yellow;
}

.footnote, .footnoteref {
    font-size: 0.8em;
}

span.footnote, span.footnoteref {
    vertical-align: super;
}

#footnotes {
    margin: 20px 0 20px 0;
    padding: 7px 0 0 0;
}

#footnotes div.footnote {
    margin: 0 0 5px 0;
}

#footnotes hr {
    border: none;
    border-top: 1px solid silver;
    height: 1px;
    text-align: left;
    margin-left: 0;
    width: 20%;
    min-width: 100px;
}


@media print {
    div#footer-badges {
        display: none;
    }
}

div#toc {
    margin-bottom: 2.5em;
}

div#toctitle {
    color: #527bbd;
    font-family: sans-serif;
    font-size: 1.1em;
    font-weight: bold;
    margin-top: 1.0em;
    margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
    margin-top: 0;
    margin-bottom: 0;
}
div.toclevel2 {
    margin-left: 2em;
    font-size: 0.9em;
}
div.toclevel3 {
    margin-left: 4em;
    font-size: 0.9em;
}
div.toclevel4 {
    margin-left: 6em;
    font-size: 0.9em;
}
/* Workarounds for IE6's broken and incomplete CSS2. */

div.sidebar-content {
    background: #ffffee;
    border: 1px solid silver;
    padding: 0.5em;
}
div.sidebar-title, div.image-title {
    color: #527bbd;
    font-family: sans-serif;
    font-weight: bold;
    margin-top: 0.0em;
    margin-bottom: 0.5em;
}

div.listingblock div.content {
    border: 1px solid silver;
    background: #f4f4f4;
    padding: 0.5em;
}

div.quoteblock-attribution {
    padding-top: 0.5em;
    text-align: right;
}

div.verseblock-content {
    white-space: pre;
}
div.verseblock-attribution {
    padding-top: 0.75em;
    text-align: left;
}

div.exampleblock-content {
    border-left: 3px solid #dddddd;
    padding-left: 0.5em;
}

/* IE6 sets dynamically generated links as visited. */
div#toc a:visited {
    color: blue;
}
</style>
<script type="text/javascript">
    /*<![CDATA[*/
    window.onload = function () {
        asciidoc.footnotes();
        asciidoc.toc(3);
    }
    var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

        /* Author: Mihai Bazon, September 2002
         * http://students.infoiasi.ro/~mishoo
         *
         * Table Of Content generator
         * Version: 0.4
         *
         * Feel free to use this script under the terms of the GNU General Public
         * License, as long as you do not remove or alter this notice.
         */

        /* modified by Troy D. Hanson, September 2006. License: GPL */
        /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
        toc: function (toclevels) {

            function getText(el) {
                var text = "";
                for (var i = el.firstChild; i != null; i = i.nextSibling) {
                    if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
                        text += i.data;
                    else if (i.firstChild != null)
                        text += getText(i);
                }
                return text;
            }

            function TocEntry(el, text, toclevel) {
                this.element = el;
                this.text = text;
                this.toclevel = toclevel;
            }

            function tocEntries(el, toclevels) {
                var result = new Array;
                var re = new RegExp('[hH]([2-' + (toclevels + 1) + '])');
                // Function that scans the DOM tree for header elements (the DOM2
                // nodeIterator API would be a better technique but not supported by all
                // browsers).
                var iterate = function (el) {
                    for (var i = el.firstChild; i != null; i = i.nextSibling) {
                        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
                            var mo = re.exec(i.tagName);
                            if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
                                result[result.length] = new TocEntry(i, getText(i), mo[1] - 1);
                            }
                            iterate(i);
                        }
                    }
                }
                iterate(el);
                return result;
            }

            var toc = document.getElementById("toc");
            var entries = tocEntries(document.getElementById("content"), toclevels);
            for (var i = 0; i < entries.length; ++i) {
                var entry = entries[i];
                if (entry.element.id == "")
                    entry.element.id = "_toc_" + i;
                var a = document.createElement("a");
                a.href = "#" + entry.element.id;
                a.appendChild(document.createTextNode(entry.text));
                var div = document.createElement("div");
                div.appendChild(a);
                div.className = "toclevel" + entry.toclevel;
                toc.appendChild(div);
            }
            if (entries.length == 0)
                toc.parentNode.removeChild(toc);
        },


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

        /* Based on footnote generation code from:
         * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
         */

        footnotes: function () {
            var cont = document.getElementById("content");
            var noteholder = document.getElementById("footnotes");
            var spans = cont.getElementsByTagName("span");
            var refs = {};
            var n = 0;
            for (i = 0; i < spans.length; i++) {
                if (spans[i].className == "footnote") {
                    n++;
                    // Use [\s\S] in place of . so multi-line matches work.
                    // Because JavaScript has no s (dotall) regex flag.
                    note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
                    noteholder.innerHTML +=
                            "<div class='footnote' id='_footnote_" + n + "'>" +
                            "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
                            n + "</a>. " + note + "</div>";
                    spans[i].innerHTML =
                            "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
                            "' title='View footnote' class='footnote'>" + n + "</a>]";
                    var id = spans[i].getAttribute("id");
                    if (id != null) refs["#" + id] = n;
    }
            }
            if (n == 0)
                noteholder.parentNode.removeChild(noteholder);
            else {
                // Process footnoterefs.
                for (i = 0; i < spans.length; i++) {
                    if (spans[i].className == "footnoteref") {
                        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
                        href = href.match(/#.*/)[0];  // Because IE return full URL.
                        n = refs[href];
                        spans[i].innerHTML =
                                "[<a href='#_footnote_" + n +
                                "' title='View footnote' class='footnote'>" + n + "</a>]";
                    }
                }
            }
        }

    }
    /*]]>*/
</script>
</head>
<body>
<div id="header">
    <h1>Documentation technique du manageur de Jacinthe</h1>
    <span id="author">Michel Demazure</span><br/>
    <span id="email"><tt>&lt;<a href="mailto:michel@demazure.com">michel@demazure.com</a>&gt;</tt></span><br/>
    <span id="revnumber">version 3.0,</span>
    <span id="revdate">février 2015</span>
    <br/><span id="revremark">version du logiciel 3</span>

    <div id="toc">
        <div id="toctitle">Table des matières</div>
        <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<h2 id="_gen_ralit_s">Genéralités</h2>
<div class="sectionbody">
    <div class="paragraph"><p>C’est un ensemble d&#8217;applications <tt>ruby</tt>, installé sur le serveur <strong>smf-gestion</strong>
        (en fait <tt>smf-gestion.ihp.fr</tt>)
        de la SMF, regroupé sous le titre <tt>JacintheManagement</tt>, abrégé en <strong>jacman</strong>.</p></div>
    <div class="paragraph"><p>Ce qui suit constitue à la fois un mode d&#8217;emploi et une documentation de plus haut
        niveau, dans le but de faciliter la maintenance et l’évolution du système.</p></div>
    <div class="admonitionblock">
        <table>
            <tr>
                <td class="icon">
                    <div class="title">Note</div>
                </td>
                <td class="content">
                    <div class="title">Notes</div>
                    <div class="paragraph"><p>Sous forme de notes telles que celle-ci, on trouvera des remarques plus
                        techniques, jouant le plus souvent un rôle de &#171;&#160;pense-bête&#160;&#187;.</p></div>
                </td>
            </tr>
        </table>
</div>
    <h3 id="_versions">Versions</h3>

    <div style="clear:left"></div>
    <div class="paragraph"><p>La version 1 a été mise en service en octobre 2013, alors que <tt>Gescom</tt> fonctionnait
        sur le serveur interne, puis modifiée pour accompagner le passage de <tt>Gescom</tt> chez Aspaway
        début décembre 2013.</p></div>
    <div class="paragraph"><p>La version 2, &#171;&#160;gémifiée&#160;&#187;, a été mise en service en octobre 2014.
        Elle comporte deux gems :
        <tt>jacman-core</tt> et <tt>jacman-qt</tt>.</p></div>
    <div class="paragraph"><p>La version 3, mise en service en décembre 2014, comporte quatre gems :
        <tt>jacman-utils</tt>, <tt>jacman-core</tt>, <tt>jacman-notifications</tt> et <tt>jacman-qt</tt>.</p></div>
    <h3 id="_logiciels_et_biblioth_ques">Logiciels et bibliothèques</h3>

    <div style="clear:left"></div>
    <div class="paragraph"><p>L’application est sous licence <em>Open Source</em> <tt>MIT</tt>. Elle n’utilise que des
        logiciels <em>Open source</em>. De façon plus précise :</p></div>
    <div class="ulist">
        <ul>
            <li>
                <p>
                    Elle fonctionne sous <tt>ruby</tt> 1.9 et 2.1 (plus précisément 1.9.3 et 2.1.0, version MRI ;
                    elle n’a pas été testée sous <tt>jruby</tt> ou <tt>rubinius</tt>).
                </p>
            </li>
            <li>
                <p>
                    Pour interroger la base de données, elle travaille en SQL natif.
                    Mais, pour la commande d&#8217;envoi du tableau de bord, elle utilise <tt>j2r-core</tt>,
                    donc nécessite les gems <tt>mysql2</tt>, <tt>sequel</tt> et <tt>prawn</tt>
                </p>
            </li>
            <li>
                <p>
                    Les interfaces graphiques (GUI = <em>graphic user interface</em>) sont développées dans le système
                    <tt>Qt</tt> (ex <em>Nokia</em>), via le gem <tt>qtbindings</tt>.
                </p>
            </li>
        </ul>
    </div>
    <h3 id="_syst_me_d_exploitation">Système d’exploitation</h3>

    <div style="clear:left"></div>
    <div class="paragraph"><p>L’application a été développée sous <em>Windows</em>, puis portée sur le serveur de la SMF
        tournant sous <em>Darwin</em> (OSX). Elle fonctionne identiquement sous les deux systèmes avec pour chacun
        l’aspect graphique natif.
        Elle fonctionne également sous <em>linux</em> (testé sous <em>CentOS.6-4</em>).</p></div>
    <div class="paragraph"><p>Les chemins de dossiers donnée dans la présente documentation sont ceux de l&#8217;installation
        d&#8217;exploitation sur le serveur <strong>smf-gestion</strong> de la SMF.</p></div>
    <h3 id="_sources_mises_jour">Sources, mises à jour</h3>

    <div style="clear:left"></div>
    <h4 id="_les_d_p_ts_tt_git_tt">Les dépôts <tt>GIT</tt></h4>

    <div class="ulist">
        <ul>
            <li>
                <p>
                    Les gems compilés, les sources sql et la documentation sont gérés sous <tt>Git</tt>. Les URL des
                    dépôts sont
                </p>
            </li>
        </ul>
    </div>
<div class="listingblock">
    <div class="content">
<pre><tt> https://mdemazure@bitbucket.org/mdemazure/gems.git
    https://mdemazure@bitbucket.org/mdemazure/SqlFiles.git
    https://mdemazure@bitbucket.org/mdemazure/j2r_doc.git</tt></pre>
    </div>
</div>
    <div class="ulist">
        <ul>
            <li>
                <p>
                    Les sources individuelles des gems sont également gérées sous <tt>Git</tt>. les URL des dépôts sont
                </p>
            </li>
        </ul>
    </div>
<div class="listingblock">
    <div class="content">
<pre><tt> https://github.com/badal/jacman-utils
    https://github.com/badal/jacman-core
    https://github.com/badal/jacman-notifications
    https://github.com/badal/jacman-qt</tt></pre>
    </div>
</div>
    <h4 id="_les_sources_sql">Les sources SQL</h4>

    <div class="paragraph"><p>Elle se trouvent dans le sous-dossier</p></div>
    <div class="listingblock">
        <div class="content">
            <pre><tt> ~gestion/SMF_SERVEUR/Jacinthe/Tools/Library/SqlFiles</tt></pre>
        </div>
    </div>
    <div class="paragraph"><p>Pour les mettre à jour, faire un <tt>git pull</tt>.</p></div>
    <h4 id="_les_gems">Les gems</h4>

    <div class="ulist">
        <ul>
            <li>
                <p>
                    Les gems sont installés dans le dossier
                </p>
            </li>
        </ul>
    </div>
    <div class="listingblock">
        <div class="content">
            <pre><tt> ~gestion/SMF_SERVEUR/Jacinthe/Tools/Library/gems</tt></pre>
        </div>
    </div>
    <div class="paragraph"><p>Pour les mettre à jour, il suffit d&#8217;un <tt>git pull</tt>, suivi d&#8217;autant de
        <tt>git install &lt;&#8230;&gt;.gem</tt> que de gems à mettre à jour.</p></div>
    <h3 id="_les_ex_cutables">Les exécutables</h3>

    <div style="clear:left"></div>
    <div class="paragraph"><p>C&#8217;est un système à quatre niveaux successifs.</p></div>
    <h4 id="_ex_cutables_ruby">Exécutables ruby</h4>

    <div class="paragraph"><p>Ils sont dans le sous-dossier <tt>lib</tt> du dossier précédent. Ils sont au nombre de
        six. Les trois principaux sont les lanceurs des interfaces graphiques : le <a
                href="#moniteur"><strong>moniteur</strong></a>, le notificateur et le <a href="#catalog"><strong>manageur
            du catalogue</strong></a>. Les trois autres sont des outils batch, que nous verrons <a href="#exec">ci-dessous</a>.
    </p></div>
    <div class="paragraph"><p>Ils sont réduits au minimum, par exemple le lanceur <tt>monitor.rb</tt> est</p></div>
    <div class="listingblock">
        <div class="content">
<pre><tt> #!/usr/bin/env ruby
    # encoding: utf-8
    require('jacman/utils')
    require('jacman/core')
    require('jacman/qt/monitor_qt')</tt></pre>
        </div>
    </div>
    <h4 id="_ex_cutables_bash">Exécutables bash</h4>

    <div class="ulist">
        <ul>
            <li>
                <p>
                    Les <strong>exécutables bash</strong> qui appellent les exécutables ruby se trouvent dans le
                    sous-dossier <tt>bin</tt> parallèle.
                </p>
            </li>
            <li>
                <p>
                    Ils sont eux-mêmes appelés via des <strong>liens symboliques</strong> qui se trouvent dans le
                    dossier
                </p>
            </li>
        </ul>
    </div>
    <div class="listingblock">
        <div class="content">
            <pre><tt> ~gestion/SMF_SERVEUR/Jacinthe/Tools/bin</tt></pre>
        </div>
    </div>
    <div class="paragraph"><p>où sont regroupées <strong>toutes les commandes bash de Jacinthe</strong>, celles de
        JacMan comme celles de J2R.</p></div>
    <div class="paragraph"><p>Ces commande ne sont accessibles directement qu&#8217;aux développeurs (utilisateur <tt>gestion</tt>
        ou superutilisateur). Pour les utilisateurs &#171;&#160;normaux&#160;&#187;, leur accès est régi par le
        mécanisme ci-après.</p></div>
    <h4 id="_commandes_tt_app_tt_de_tt_osx_tt">Commandes <tt>App</tt> de <tt>OSX</tt></h4>

    <div class="paragraph"><p>Un dossier spécial <tt>SMF_SERVEUR/Commandes</tt> contient les <tt>App</tt> de OSX qui
        lancent ces commandes, par des renvois vers les seuls exécutables &#171;&#160;autorisés&#160;&#187;, à savoir
        <tt>batman.sh</tt> et les lanceurs des interfaces graphiques. Ces commandes contiennent les</p></div>
    <div class="listingblock">
        <div class="content">
            <pre><tt> sudo -u gestion -H ...</tt></pre>
        </div>
    </div>
    <div class="paragraph"><p>qui en réservent l&#8217;utilisation aux &#171;&#160;sudoers&#160;&#187; de l&#8217;utilisateur
        <tt>gestion</tt>. Voir <tt>/etc/sudoers</tt>).</p></div>
    <div class="paragraph"><p>Les exécutables <tt>cronman.sh</tt> et <tt>jacdev.sh</tt> n&#8217;apparaissent pas dans
        ces liens et ne sont donc accessibles qu&#8217;aux développeurs (utilisateur <tt>gestion</tt> ou
        superutilisateur).</p></div>
</div>
    <h2 id="_le_gem_tt_jacman_utils_tt">Le gem <tt>jacman-utils</tt></h2>

    <div class="sectionbody">
<div class="listingblock">
    <div class="content">
<pre><tt>Files: 10
    Modules: 8
    Classes: 5
    Constants: 40
    Methods: 59</tt></pre>
    </div>
</div>
        <div class="paragraph"><p>C&#8217;est la base commune de toutes les applications. Il contient deux types de
            fichiers.</p></div>
        <div class="paragraph"><p>D&#8217;une part des utilitaires d&#8217;usage commun et d&#8217;autre part des outils
            de configuration et de paramétrage du système que nous verrons <a href="#config_systeme">plus en détail</a>.
        </p></div>
        <div class="paragraph"><p>Les divers fichiers utilitaires sont</p></div>
        <div class="ulist">
            <ul>
                <li>
                    <p>
                        <tt>files_utilities.rb</tt>, divers outils de manipulation de fichiers.
                    </p>
                </li>
                <li>
                    <p>
                        <tt>smf_mail.rb</tt>, simple emballage du gem <tt>mail</tt>.
                    </p>
                </li>
                <li>
                    <p>
                        <tt>sylk2csv.rb</tt>, conversion du format SYLK vers CSV.
                    </p>
                </li>
                <li>
                    <p>
                        <tt>win_file.rb</tt>, conversion entre fichiers Windows et fichiers Unix/utf-8.
                    </p>
                </li>
                <li>
                    <p>
                        <tt>sql.rb</tt>, exécution de commandes SQL génériques.
                    </p>
                </li>
                <li>
                    <p>
                        <tt>sql_tools.rb</tt>, manipulations SQL spécifiques à Jacinthe.
                    </p>
                </li>
                <li>
                    <p>
                        <tt>sql_files.rb</tt>, management des fichiers sources SQL et des fichiers JSON associés.
                    </p>
                </li>
            </ul>
        </div>
        <h3 id="config-systeme">Configuration</h3>

        <div style="clear:left"></div>
        <div class="paragraph"><p>Deux fichiers ruby y sont consacrés :</p></div>
        <div class="ulist">
            <ul>
                <li>
                    <p>
                        <tt>config.rb</tt>, lecture du fichier de configuration.
                    </p>
                </li>
                <li>
                    <p>
                        <tt>server_directories.rb</tt>, constantes du module <tt>Core</tt> donnant les chemins des
                        divers dossiers de travail.
                    </p>
                </li>
            </ul>
        </div>
        <div class="paragraph"><p>La configuration du système, propre à chaque installation, est fournie par un fichier
            en format <tt>YAML</tt>, dont le chemin est fourni par la variable d&#8217;environnement
            <tt>JACMAN_CONFIG</tt>, en l'état actuel :</p></div>
        <div class="listingblock">
            <div class="content">
<pre><tt>    &gt; env
    ...
    JACMAN_CONFIG = /Users/gestion/Jacinthe/Tools/Library/jacman_config.ini
    ...</tt></pre>
            </div>
        </div>
        <div class="paragraph"><p>Voici son contenu:</p></div>
        <div class="listingblock">
            <div class="content">
<pre><tt>---
    real: true
    mysql:
    command: /user/local/mysql/bin/mysql
    dump_command: /user/local/mysql/bin/mysqldump
    host: localhost
    admin:
    user: tiers_admin
    password: ********
    root:
    user: root
    password: ********
    databases:
    jacinthe:
    JacintheD
    catalog:
    catalogue
    paths:
    server: /Users/gestion/SMF_SERVEUR
    dump: /Users/gestion/Public
    defaults: /Users/gestion/Jacinthe/Tools/Library/jacman_defaults.ini
    mail:
    server: smtp.ihp.fr</tt></pre>
            </div>
        </div>
        <div class="paragraph"><p>Quelques remarques :</p></div>
        <div class="ulist">
            <ul>
                <li>
                    <p>
                        <tt>real: true</tt> met en service l&#8217;automatisme d&#8217;intégration des ventes, qu&#8217;on
                        peut donc suspendre lors de tests.
                    </p>
                </li>
                <li>
                    <p>
                        <tt>dump:</tt> désigne un dossier public (MySQL demande un dossier public pour écrire),
                    </p>
                </li>
                <li>
                    <p>
                        <tt>defaults:</tt> désigne le chemin du fichier des valeurs par défaut, voir
                        <a href="#defauts">ci-dessous</a>.
                    </p>
                </li>
                <li>
                    <p>
                        <tt>mysql:</tt> contient les paramètres de connexion au serveur interne de <tt>MySQL</tt> (les
                        connexions aux <a href="#exterieur">serveurs externes</a> sont décrites dans les fichiers <tt>transmission.rb</tt>
                        et <tt>aspaway_importer.rb</tt> du gem <tt>jacman-core</tt>).
                    </p>
                </li>
            </ul>
        </div>
        <h3 id="_dossiers_de_travail">Dossiers de travail</h3>

        <div style="clear:left"></div>
        <div class="paragraph"><p>A partir du chemin <tt>paths:server:</tt> donné dans le fichier de configuration,
            on construit les chemins d&#8217;accès aux divers dossiers d&#8217;exploitation. Voici un extrait du fichier
            <tt>server_directories.rb</tt> :</p></div>
        <div class="listingblock">
            <div class="content">
<pre><tt> module JacintheManagement
    module Core
    # free access directory
    SQL_DUMP_DIR = Conf.config['paths']['dump']
    # top path
    SMF_SERVEUR = Conf.config['paths']['server']
    # second level paths
    TRANSFERT_DIR = File.join(SMF_SERVEUR, 'Transfert')
    DATADIR = File.join(SMF_SERVEUR, 'Data')
    # SQL script files
    SQL_SCRIPT_DIR = File.join(SMF_SERVEUR, 'Jacinthe', 'Tools', 'Library', 'SqlFiles')
    # model mail files
    MODEL_DIR = File.join(SMF_SERVEUR, 'Jacinthe', 'Tools', 'Templates', 'Mail')
    end
    end</tt></pre>
            </div>
        </div>
        <div class="paragraph"><p>On voit apparaître les dossiers essentiels :</p></div>
        <div class="hdlist">
            <table>
                <tr>
                    <td class="hdlist1">
                        <strong>TRANSFERT_DIR</strong>
                        <br/>
                    </td>
                    <td class="hdlist2">
                        <p style="margin-top: 0;">
                            les fichiers de transfert avec <strong>Gescom</strong> (clients, ventes et catalogue),
                        </p>
                    </td>
                </tr>
                <tr>
                    <td class="hdlist1">
                        <strong>DATADIR</strong>
                        <br/>
                    </td>
                    <td class="hdlist2">
                        <p style="margin-top: 0;">
                            les dumps de la base, les autres fichiers de transfert et des fichiers de renseignement
                            divers.
                        </p>
                    </td>
                </tr>
                <tr>
                    <td class="hdlist1">
                        <strong>SQL_SCRIPT_DIR</strong>
                        <br/>
                    </td>
                    <td class="hdlist2">
                        <p style="margin-top: 0;">
                            les sources des commandes <tt>MySQL</tt>. Notons au passage que les commandes utilisées ne
                            se trouvent pas en dur dans le code, mais que le code les lit à la demande dans ces
                            fichiers.
                        </p>
                    </td>
                </tr>
                <tr>
                    <td class="hdlist1">
                        <strong>MODEL_DIR</strong>
                        <br/>
                    </td>
                    <td class="hdlist2">
                        <p style="margin-top: 0;">
                            les modèles des mails de notification des abonnerments électroniques.
                        </p>
                    </td>
                </tr>
            </table>
        </div>
</div>
    <h2 id="_le_gem_tt_jacman_notifications_tt">Le gem <tt>jacman-notifications</tt></h2>

    <div class="sectionbody">
<div class="listingblock">
    <div class="content">
<pre><tt>Files: 6
    Modules: 4
    Classes: 4
    Constants: 12
    Methods: 59</tt></pre>
    </div>
</div>
        <div class="paragraph"><p>Il utilise <tt>jacman-utils</tt> et concerne les notifications par e-mail des
            abonnements électroniques. Il est formé essentiellement de trois fichiers.</p></div>
        <h3 id="_le_fichier_tt_base_rb_tt">Le fichier <tt>base.rb</tt></h3>

        <div style="clear:left"></div>
        <div class="paragraph"><p>En dehors de méthodes utilitaires variées, il est essentiellement à construire et
            &#171;&#160;cacher&#160;&#187; les données utiles.</p></div>
        <div class="paragraph"><p>On commence par récupérer un jeu d&#8217;informations sur tous les tiers valides :</p>
        </div>
        <div class="listingblock">
            <div class="content">
<pre><tt>SELECT tiers_id, tiers_nom, tiers_prenom, tiers_ip_plage, tiers_ip_mails, tiers_drupal
    FROM tiers
    LEFT JOIN etat_tiers ON tiers_etat = etat_tiers_id
    WHERE etat_tiers_nom LIKE 'valide';</tt></pre>
            </div>
        </div>
        <div class="paragraph"><p>qu&#8217;on stocke (cache) dans un Array <tt>@all_jacinthe_tiers</tt> dont les indices
            sont les <tt>tiers_id</tt> et les valeurs des <tt>Struct</tt> regroupant ces informations, nommées
            <tt>Tiers</tt>.</p></div>
        <div class="ulist">
            <ul>
                <li>
                    <p>
                        La méthode <tt>Base.find_tiers(tiers_id)</tt> retourne la Struct Tiers correspondante à l&#8217;identifiant
                        du tiers.
                    </p>
                </li>
            </ul>
        </div>
        <div class="paragraph"><p>On récupère de la même façon un jeu d&#8217;informations sur tous les abonnements
            électroniques (code = <em>E</em>), qui restent à notifier pour l&#8217;année en cours et la suivante.</p>
        </div>
        <div class="listingblock">
            <div class="content">
<pre><tt>SELECT abonnement_id, revue_nom, abonnement_annee, abonnement_reference_commande, abonnement_facture, tiers_id
    FROM abonnement
    LEFT JOIN type_abonnement ON abonnement_type = type_abonnement_id
    LEFT JOIN client_sage ON abonnement_client_sage = client_sage_id
    LEFT JOIN tiers ON client_sage_client_final = tiers_id
    LEFT JOIN revue ON abonnement_revue = revue_id
    WHERE type_abonnement_code = 'E'
    AND abonnement_ignorer = 0
    AND abonnement_ip_a_notifier = 1
    AND abonnement_annee &gt;= YEAR(NOW());</tt></pre>
            </div>
        </div>
        <div class="paragraph"><p>qu&#8217;on trie suivant la revue et l&#8217;année concernée et qu&#8217;on stocke
            (cache) dans un Hash <tt>@classified_notifications</tt> dont les clés sont les couples [revue, année] et les
            valeurs des <tt>Struct</tt> regroupant les informations, nommées <tt>ToBeNotified</tt>.</p></div>
        <div class="ulist">
            <ul>
                <li>
                    <p>
                        La méthode <tt>Base.classified_notifications</tt> retourne ce Hash.
                    </p>
                </li>
            </ul>
        </div>
        <h3 id="_le_fichier_tt_selector_rb_tt">Le fichier <tt>selector.rb</tt></h3>

        <div style="clear:left"></div>
        <div class="paragraph"><p>On crée une instance <tt>Selector.new(keys)</tt> à partir de la liste des clés [revue,
            année] choisies, ce qui sélectionne les <tt>ToBeNotified</tt> concernées, et produit (cache) à deux listes
            (Array) permettant de répondre aux deux méthodes suivantes.</p></div>
        <div class="ulist">
            <ul>
                <li>
                    <p>
                        La méthode <tt>Selector.new(keys).tiers_list</tt> retourne la liste des tiers concernés
                    </p>
                </li>
                <li>
                    <p>
                        La méthode <tt>Selector.new(keys).to_be_notified_for(tiers_id)</tt> retourne la liste des <tt>ToBeNotified</tt>
                        du <tt>Tiers</tt> correspondant.
                    </p>
                </li>
            </ul>
        </div>
        <h3 id="_le_fichier_tt_notifier_rb_tt">Le fichier <tt>notifier.rb</tt></h3>

        <div style="clear:left"></div>
        <h4 id="_la_commande_de_notification">La commande de notification</h4>

        <div class="paragraph"><p>Les notifications pour un tiers et une liste de ToBeNotified sont lancées par la
            commande</p></div>
        <div class="ulist">
            <ul>
                <li>
                    <p>
                        Notifier.new(tiers_id, liste).notify
                    </p>
                </li>
            </ul>
        </div>
        <h4 id="_le_m_canisme">Le mécanisme</h4>

        <div class="paragraph"><p>Le mécanisme mis en route est le suivant :</p></div>
        <div class="ulist">
            <ul>
                <li>
                    <p>
                        On récupère les adresses mail du Tiers et on les trie suivant qu&#8217;elles sont en .fr ou pas,
                        pour choisir la langue des messages. Le nombre de messages à produire sera suivant les cas 0
                        (aucune adresse), 1 (une langue) ou 2 (deux langues).
                    </p>
                </li>
                <li>
                    <p>
                        On enregistre dans un fichier les tiers_id des <tt>Tiers</tt> ne disposant pas d&#8217;adresses
                        mail et pour chacun le nombre de notifications concernées (voir le fichir <tt>register.rb</tt>).
                    </p>
                </li>
                <li>
                    <p>
                        Chaque message est basé sur un modèle (stocké dans le dossier <tt>Core::MODEL_DIR</tt>)
                        contenant des &#171;&#160;jokers&#160;&#187;, qu&#8217;on replace par les valeurs tirées du <tt>Tiers</tt>.
                    </p>
                </li>
            </ul>
        </div>
        <div class="listingblock">
            <div class="content">
<pre><tt> def substitutions
    {
    TIERS_ID: @tiers.tiers_id.to_s,
    NAME: @tiers.name,
    RANGES: @tiers.ranges.join("\n"),
    REVUES: @subscriptions.map(&amp;:report).join("\n"),
    DRUPAL: @tiers.drupal.to_s
    }
    end</tt></pre>
            </div>
        </div>
        <div class="ulist">
            <ul>
                <li>
                    <p>
                        On expédie les messages, avec les paramètres d&#8217;envoi donnés dans la configuration générale
                        de <strong>JacMan</strong>.
                    </p>
                </li>
            </ul>
        </div>
</div>
    <h2 id="_le_gem_tt_jacman_core_tt">Le gem <tt>jacman-core</tt></h2>
<div class="sectionbody">
    <div class="listingblock">
        <div class="content">
<pre><tt>Files: 28
    Modules: 14
    Classes: 8
    Constants: 73
    Methods: 188</tt></pre>
        </div>
    </div>
    <div class="paragraph"><p>Il utilise <tt>jacman-utils</tt>, ainsi que <tt>j2r-jaccess</tt> et <tt>j2r-core</tt> pour
        une raison qu&#8217;on verra <a href="#tb">plus loin</a>.</p></div>
    <div class="paragraph"><p>Il contient toutes les commandes de management, à l&#8217;exception du mécanisme de
        notification qui dispose comme on l&#8217;a vu de son propre gem.</p></div>
    <div class="paragraph"><p>Le dossier <strong>core</strong> contient notamment deux sous-dossiers :</p></div>
    <div class="hdlist">
        <table>
            <tr>
                <td class="hdlist1">
                    <strong>commands</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        les diverses commandes (classe <tt>Command</tt>)
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>components</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        une petite vingtaine de fichiers contenant les méthodes implantant effectivement ces commandes.
                    </p>
                </td>
            </tr>
        </table>
    </div>
    <h3 id="commandes">Les commandes</h3>

    <div style="clear:left"></div>
    <div class="paragraph"><p>Au niveau fonctionnel, JacintheManagement regroupe un ensemble de commandes individuelles,
        la plupart concernant la liaison de Jacinthe avec le reste du système d&#8217;information de la SMF.</p></div>
<div class="sidebarblock">
    <div class="sidebar-content">
        <div class="paragraph"><p>Lorsqu&#8217;on utilisera ci-dessous les mots &#171;&#160;importer&#160;&#187; et
            &#171;&#160;exporter&#160;&#187; sans qualificatif, ce sera toujours entendu du point de vue de Jacinthe. On
            importe dans Jacinthe et on exporte depuis Jacinthe.</p></div>
    </div>
</div>
    <h4 id="exterieur">Le monde extérieur</h4>

    <div class="paragraph"><p>Ce &#171;&#160;reste du monde&#160;&#187; avec lequel Jacinthe communique est formé des
        quatre composants suivants :</p></div>
    <div class="ulist">
        <ul>
            <li>
                <p>
                    Le serveur <strong>smf</strong>, plus connu en interne sous le nom de <strong>drupal</strong>,
                    hébergé par Mathrice : plus précisément, il s&#8217;agit de <tt>smf.emath.fr</tt>, d&#8217;adresse
                    134.206.83.32, mail géré par <tt>smail.math.u-bordeaux1.fr</tt>.
                </p>
            </li>
            <li>
                <p>
                    Le serveur <strong>smf4</strong>, également hébergé par Mathrice, plus précisément
                    <tt>smf4.emath.fr</tt>, d&#8217;adresse 134.206.83.16, mail géré comme ci-dessus.
                </p>
            </li>
            <li>
                <p>
                    Les deux serveurs (<strong>smf-2.ihp.fr</strong> et le serveur d'<strong>Aspaway</strong>) utilisés
                    dans la communication avec le logiciel <tt>Gescom</tt> de SAGE.
                </p>
            </li>
        </ul>
    </div>
    <h4 id="_le_cas_de_tt_gescom_tt">Le cas de <tt>Gescom</tt></h4>

    <div class="paragraph"><p>La situation du logiciel Gescom (composante du système <tt>Sage</tt> consacrée à la
        GEStion COMmerciale) est très spéciale pour plusieurs raisons.</p></div>
    <div class="paragraph"><p>D&#8217;abord, il est installé, sur un serveur distant (serveur d&#8217;Aspaway à
        Clichy).</p></div>
    <div class="paragraph"><p>Ensuite, il fonctionne dans un environnement différent (<tt>Windows</tt>). Les fichiers qu&#8217;il
        lit et qu&#8217;il écrit sont aux normes <tt>Windows</tt> (encodage et fins de lignes)</p></div>
<div class="admonitionblock">
    <table>
        <tr>
            <td class="icon">
                <div class="title">Note</div>
            </td>
            <td class="content">
                <div class="title">Conversions</div>
                <div class="paragraph"><p>Les routines de conversion des fichiers sont rassemblées dans un module
                    (classe <tt>WinFile</tt>). Le fichier source est <tt>lib/jacman/core/utils/win_file.rb</tt>.</p>
                </div>
            </td>
        </tr>
    </table>
</div>
    <div class="paragraph"><p>Enfin, les communications se font par l&#8217;intermédiaire de fichiers. Cela couvre deux
        situations non symétriques :</p></div>
    <div class="ulist">
        <ul>
            <li>
                <p>
                    De Jacinthe vers Gescom, on écrit un fichier par le manageur, ce fichier est transmis au serveur d&#8217;Aspaway.
                    Il faut aller le lire avec Gescom. Après lecture, on le renvoie vers Jacinthe, qui du coup sait qu&#8217;il
                    a été lu.
                </p>
            </li>
            <li>
                <p>
                    De Gescom vers Jacinthe, on écrit le fichier par Gescom, on le transmet à <tt>smf-2</tt>. Cette
                    transmission est détectée automatiquement par le manageur qui procède à l&#8217;importation dans
                    Jacinthe.
                </p>
            </li>
        </ul>
    </div>
<div class="paragraph"><p>On précisera <a href="#Aspaway">plus loin</a> ces mécanismes.</p></div>
    <h4 id="_les_commandes_de_management_courant">Les commandes de management courant</h4>

    <div class="paragraph"><p>Elles couvrent les opérations usuelles de gestion du système. Leurs noms sont abrégés par
        un groupe de deux lettres, le premier désignant le &#171;&#160;partenaire&#160;&#187; ou le cadre, l&#8217;autre
        référant au contenu de l&#8217;opération. On a ainsi :</p></div>
    <div class="hdlist">
        <table>
            <tr>
                <td class="hdlist1">
                    <strong>gi</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Gescom Import) : Importer les ventes depuis <strong>Gescom</strong>.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>ge</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Gescom Export) : Exporter les clients vers <strong>Gescom</strong>.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>gr</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Gescom Re-envoyer) : Envoyer à nouveau à <strong>Gescom</strong> en cas d&#8217;erreur.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>di</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Drupal Import) : Importer les informations depuis <strong>Drupal</strong>.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>de</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Drupel export) : Exporter les informations vers <strong>Drupal</strong>.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>ea</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Electronique Abonnements) : Exporter des abonnements électroniques vers <strong>smf4</strong>.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>ep</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Electronique Plages) : Exporter les plages IP vers <strong>smf4</strong>.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>ca</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Catalogue Articles) : Importer au catalogue les articles depuis <strong>Gescom</strong>.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>ct</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Catalogue Tarifs) : Importer au catalogue les tarifs depuis <strong>Gescom</strong>.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>cn</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Catalogue Nomenclature) : Importer au catalogue la nomenclature depuis <strong>Gescom</strong>.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>cs</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Catalogue Stocks) : Importer au catalogue les stocks depuis <strong>Gescom</strong>.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>ce</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Catalogue Export) : Exporter le catalogue.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>tb</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Tableau de Bord) : Créer et envoyer le tableau de bord.
                    </p>
                </td>
            </tr>
        </table>
    </div>
    <div class="quoteblock" id="tb">
        <div class="title">L&#8217;envoi du tableau de bord</div>
        <div class="quoteblock-content">
            <div class="paragraph"><p>Cette opération, rattachée au manageur par commodité, nécessite la création du
                tableau de bord, opération qui est elle rattachée logiquement à <tt>J2R</tt>. Ainsi, elle réclame l&#8217;appel
                aux gems <tt>j2r-jaccess</tt> et <tt>j2r-core</tt>.</p></div>
</div>
        <div class="quoteblock-attribution">
        </div>
    </div>
<div class="admonitionblock">
    <table>
        <tr>
            <td class="icon">
                <div class="title">Note</div>
            </td>
            <td class="content">
                <div class="title">Noms des dossiers et fichiers du catalogue</div>
                <div class="paragraph"><p>Les noms des dossiers et fichiers d&#8217;exportation de Gescom pour le
                    catalogue (<tt>Articles</tt> par exemple) sont parfois au singulier, parfois au pluriel, de façon
                    surprenante (<tt>Nomenclatures</tt>, mais <tt>Stock</tt>). C&#8217;est un résidu de l&#8217;histoire,
                    que je n&#8217;ai pas voulu modifier. Il faudra un jour normaliser cela et renommer les choses dans
                    le code et sur le serveur. Il en est de même des alternances orthographiques entre homonymes
                    français et anglais : transfert/transfer, tarif/tariff &#8230;</p></div>
            </td>
        </tr>
    </table>
</div>
    <h4 id="_les_commandes_d_8217_information">Les commandes d&#8217;information</h4>

    <div class="paragraph"><p>Elles sont au nombre de quatre.</p></div>
    <div class="hdlist">
        <table>
            <tr>
                <td class="hdlist1">
                    <strong>help</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Aide) : ouvre le dialogue d&#8217;aide.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>vers</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Versions) : donne les versions des divers gems.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>conf</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Configuration) : permet de connaître ou modifier les valeurs par défaut, voir <a
                            href="#defauts">ci-dessous</a>.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>infos</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Informations) : donne des informations sur l'état de Jacinthe, et notamment les opérations
                        pendantes :
                    </p>
                </td>
            </tr>
        </table>
    </div>
<div class="listingblock">
    <div class="content">
<pre><tt> $&gt; batman infos
    26 ventes non importées
    1 fichiers clients en cours
    12 clients à exporter
    5 notifications à faire</tt></pre>
    </div>
</div>
    <h4 id="_les_commandes_r_serv_es">Les commandes réservées</h4>

    <div class="paragraph"><p>Il s&#8217;agit de commandes réservées aux développeurs, non accessibles par les
        interfaces graphiques. Ce sont :</p></div>
    <div class="hdlist">
        <table>
            <tr>
                <td class="hdlist1">
                    <strong>jpd</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Jacinthe Partial Dump) : dump partiel de la base de données.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>jtd</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Jacinthe Total Dump) : dump total de la base de données.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>jpr</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Jacinthe Partial Reset) : restauration partielle de la base de données.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>jtr</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Jacinthe Total Reset) : restauration totale de la base de données
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>clone</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Clone) : construire un clone de la base
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>crb</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        (Catalogue Reset Base) : restauration partielle de la base catalogue
                    </p>
                </td>
            </tr>
        </table>
    </div>
    <h4 id="exec">Les outils batch</h4>
<div class="paragraph"><p>Il sont au nombre de trois :</p></div>
    <div class="ulist">
        <ul>
            <li>
                <p>
                    <tt>batman</tt> permet de lancer les commandes courantes et d&#8217;information en mode console,
                </p>
            </li>
            <li>
                <p>
                    <tt>jacdev</tt> est analogue pour les commandes réservées,
                </p>
            </li>
            <li>
                <p>
                    <tt>cronman</tt> permet de lancer les commandes courantes, mais déroute les messages vers des
                    fichiers.
                </p>
            </li>
        </ul>
    </div>
    <h3 id="_le_manageur_batch_tt_batman_tt">Le manageur batch : <tt>batman</tt></h3>

    <div style="clear:left"></div>
    <div class="paragraph"><p>Seul de ces trois outils, <tt>batman</tt> est donc accessible aux utilisateurs &#171;&#160;normaux&#160;&#187;.
        Voici un exemple de session :</p></div>
<div class="listingblock">
    <div class="content">
<pre><tt>$&gt; batman help
    Liste des commandes du manageur :

    &lt;vide&gt; ou &lt;erreur&gt; : cette réponse
    help : cette réponse
    help &lt;commande&gt; : aide sur &lt;commande&gt;

    gi : Importer dans Jacinthe les nouvelles ventes à partir d'un fichier fourni par Gescom
    ge : Extraire de JacintheD la liste des nouveaux clients et l'enregistrer dans un fichier
    gr : Envoyer à nouveau les fichiers clients construits précédemment et non reçus
    di : Importer dans Jacinthe les données contenues dans le serveur smf
    de : Transférer les données depuis JacintheD vers le serveur smf
    ca : Importer dans Jacinthe la liste des articles fournie par Gescom
    cn : Importer dans Jacinthe la nomenclature fournie par Gescom
    ct : Importer dans Jacinthe la liste des tarifs fournie par Gescom
    cs : Importer dans Jacinthe l'état des stocks fourni par Gescom
    ce : Récupérer dans un fichier les éléments du catalogue extraits de Jacinthe
    ep : Envoyer au serveur smf4 les plages IP valides
    ea : Envoyer au serveur smf4 les abonnements électroniques
    ei : Ouvrir dans un éditeur la liste des plages invalides
    tb : Construire le tableau de bord du jour et l'envoyer aux destinataires fixés

    infos : Opérations pendantes
    conf : Configuration du manageur
    vers : Versions des composantes

    $&gt; batman help ce
    Commande : Exporter le catalogue
    Cette commande permet d'extraire de Jacinthe
    de quoi fabriquer le catalogue.

    Les renseignements extraits sont enregistrés dans le fichier 'catalog.csv'
    qui se trouve dans le dossier C:/Users/gestion/SMF_SERVEUR/Data.

    $&gt; batman ce
    executing 'Exporter le catalogue'
    Dumping catalog data into file /Users/gestion/SMF_SERVEUR/Data/catalogue.csv.
    end of execution</tt></pre>
    </div>
</div>
    <h4 id="defauts">Paramétrage de <tt>batman</tt></h4>
<div class="paragraph"><p>Un petit nombre de paramètres sont disponibles :</p></div>
    <div class="hdlist">
        <table>
            <tr>
                <td class="hdlist1">
                    <strong>years</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        pour la commande <tt>de</tt> : nombre d&#8217;années d&#8217;activité à transférer à <strong>Drupal</strong>.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>bonus</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        pour la commande <tt>ea</tt> : bonus d&#8217;abonnement électronique en début d&#8217;année
                        suivante.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>from</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        pour l&#8217;envoie des mails : adresse de l&#8217;expéditeur.
                    </p>
                </td>
            </tr>
            <tr>
                <td class="hdlist1">
                    <strong>report</strong>
                    <br/>
                </td>
                <td class="hdlist2">
                    <p style="margin-top: 0;">
                        pour la commande <tt>tb</tt> : adresse(s) d&#8217;envoi du tableau de bord.
                    </p>
                </td>
            </tr>
        </table>
    </div>
    <div class="paragraph"><p>On peut les modifier par <tt>batman conf</tt>. La session suivante suffit à expliquer :
    </p></div>
<div class="listingblock">
    <div class="content">
<pre><tt> $&gt; batman conf
    Fixe les valeurs des variables de configuration
    Commande commune à batman et jacdev. Usage:
    &lt;cmd&gt; désigne batman ou jacdev indifféremment.
    &lt;cmd&gt; conf years N : nombre d'années d'activité à transférer à drupal
    : actuellement 4
    &lt;cmd&gt; conf bonus MM-JJ : bonus d'abonnement électronique l'année suivante
    : modèle MM-JJ, exemple 04-01 (premier avril)
    : actuellement 04-01
    &lt;cmd&gt; conf from ADR : adresse de l'expéditeur des notifications
    : actuellement smf@dma.ens.fr
    &lt;cmd&gt; conf report ADR[ ADR ...] : adresse(s) d'envoi du tableau de bord
    : actuellement smf.president@gmail.com

    $&gt; batman conf years
    Commande commune à batman et jacdev. Usage:
    &lt;cmd&gt; désigne batman ou jacdev indifféremment.
    &lt;cmd&gt; conf years N : nombre d'années d'activité à transférer à drupal
    : actuellement 4

    $&gt; batman conf years 5
    nouvelle valeur 5 ; confirmez-vous ? [YyOo]
    y
    nouvelle valeur 5

    $&gt; batman conf years 4
    nouvelle valeur 4 ; confirmez-vous ? [YyOo]
    y
    nouvelle valeur 4</tt></pre>
    </div>
</div>
<div class="admonitionblock">
    <table>
        <tr>
            <td class="icon">
                <div class="title">Note</div>
            </td>
            <td class="content">
                <div class="title">Le fichier <tt>defaults.ini</tt></div>
                <div class="paragraph"><p>Les valeurs des paramètres sont stockées dans un fichier <tt>jacman_defaults.ini</tt>
                    au format YAML sur
                    lequel on peut intervenir directement.</p></div>
            </td>
        </tr>
    </table>
</div>
    <h4 id="_cronman">cronman</h4>

    <div class="paragraph"><p>Comme on l&#8217;a dit, <tt>cronman</tt> est une simple variante de <tt>batman</tt>,
        destinée notamment à
        l&#8217;exécution automatique par le démon <tt>cron</tt>, d&#8217;où son nom.</p></div>
<div class="admonitionblock" id="cron">
    <table>
        <tr>
            <td class="icon">
                <div class="title">Note</div>
            </td>
            <td class="content">
                <div class="title">Le dossier <tt>Cron</tt></div>
                <div class="paragraph"><p>La commande <tt>cronman xy</tt>, où <tt>xy</tt> est l&#8217;une des commandes
                    &#171;&#160;normales&#160;&#187;, exécute <tt>batman xy</tt>,
                    mais déroute la sortie standard dans un fichier <tt>stdout_xy.txt</tt> et la sortie d&#8217;erreur
                    dans un fichier <tt>stderr_xy.txt</tt>. Ces fichiers se trouvent dans le sous-dossier
                    <strong>Cron</strong> du dossier DATADIR. L&#8217;existence et la date de ces fichiers permettent au
                    manageur de surveiller les opérations automatiques.</p></div>
            </td>
        </tr>
    </table>
</div>
    <h4 id="_jacdev">jacdev</h4>

    <div class="paragraph"><p><tt>jacdev</tt> est identique à <tt>batman</tt>, sauf qu&#8217;il concerne seulement les
        cinq commandes de développement
        (ainsi que <tt>conf</tt> et <tt>infos</tt>)</p></div>
    <h3 id="_les_automatismes">Les automatismes</h3>

    <div style="clear:left"></div>
    <div class="paragraph"><p>En plus du déclenchement nocturne (par le démon <tt>cron</tt> du système) d&#8217;opérations
        de maintenance
        (voir <a href="#surveillance">ci-dessous</a>), <tt>JacintheManagement</tt> prévoit l&#8217;importation
        automatique
        dans Jacinthe des fichiers exportés par <tt>Gescom</tt>.</p></div>
    <div class="paragraph"><p>Le mécanisme consiste à utiliser <tt>cronman</tt> et à comparer la date du fichier &#171;&#160;source&#160;&#187;
        fourni par <tt>Gescom</tt> et la date du fichier <tt>stdout_??.txt</tt> produit par <tt>cronman</tt>.
        C&#8217;est très simple (voir <tt>aspaway_updater.rb</tt> dans <tt>jacman-core</tt>).</p></div>
    <div class="admonitionblock">
        <table>
            <tr>
                <td class="icon">
                    <div class="title">Note</div>
                </td>
                <td class="content">
                    <div class="title">Gestion des automatismes</div>
                    <div class="paragraph"><p>C&#8217;est la boucle de rafraichissement de l&#8217;affichage de l&#8217;heure
                        du moniteur (pour les ventes,
                        ou du manageur du catalogue pour le catalogue) qui gère ces automatismes.
                        Ils ne sont donc effectifs que lorsque les GUI sont en fonctionnement.
                        Ainsi, si une exportation de <tt>Gescom</tt> a lieu alors que le GUI n&#8217;est pas lancé,
                        l&#8217;automatisme ne sera démarré qu&#8217;au lancement du GUI. Cela explique pourquoi le
                        moniteur comporte deux indicateurs : la date du fichier source et la date
                        (et la réussite) de l&#8217;importation.</p></div>
                    <div class="paragraph"><p>En outre, à la fois pour éviter de charger inutilement le serveur,
                        et pour que les anomalies soient détectées au plus vite, la boucle de rafraichissement est
                        arrêtée
                        lorsque le GUI est minimisé (&#171;&#160;iconifié&#160;&#187;), de sorte que les automatismes ne
                        sont déclenchés que
                        lorsque le GUI est &#171;&#160;ouvert&#160;&#187;.</p></div>
                </td>
            </tr>
        </table>
</div>
</div>
<h2 id="Aspaway">Les communications entre Jacinthe et Sage (Gescom)</h2>
<div class="sectionbody">
    <h3 id="_serveurs_utilisateurs_dossiers">Serveurs, utilisateurs, dossiers</h3>

    <div style="clear:left"></div>
    <div class="paragraph"><p>Cela fait intervenir trois environnements : trois serveurs, trois utilisateurs et trois
        jeux de dossiers.</p></div>
    <div class="ulist">
        <ul>
            <li>
                <p>
                    L&#8217;environnement de Jacinthe
                </p>
            </li>
        </ul>
    </div>
<div class="listingblock">
    <div class="content">
<pre><tt> Serveur : smf_gestion.ifp.fr (134.157.87.33), système OSX
    Utilisateur : gestion
    Dossier : /home/gestion/SMF_SERVEUR/Transfert, abrégé ci-dessous en TR_J</tt></pre>
    </div>
</div>
    <div class="ulist">
        <ul>
            <li>
                <p>
                    L&#8217;environnement de Sage (chez Aspaway)
                </p>
            </li>
        </ul>
    </div>
<div class="listingblock">
    <div class="content">
<pre><tt> Serveur : 185.7.39.70, système Windows, sous-système Cygwin
    Utilisateur : SMF_SFTP pour Cygwin
    Dossier : D:\wrk\Sagei7\transferts (soit /cygdrive/d/wrk/Sagei7/transferts pour Cygwin), abrégé en TR_S</tt></pre>
    </div>
</div>
    <div class="ulist">
        <ul>
            <li>
                <p>
                    L&#8217;environnement d&#8217;Aspaway (à la SMF)
                </p>
            </li>
        </ul>
    </div>
<div class="listingblock">
    <div class="content">
<pre><tt> Serveur : smf-2.ihp.fr (134.157.87.29), système Debian
    Utilisateur : Aspaway
    Dossier : /home/Aspaway/transfert, abrégé ci-dessous en TR_A</tt></pre>
    </div>
</div>
    <div class="paragraph"><p>Les transferts se font de 1 vers 2 dans le sens Jacinthe-Sage et de 2 vers 3 dans le sens
        Sage-Jacinthe.
        Les trois dossiers TR ont des structures parallèles comme on le verra ci-dessous.</p></div>
    <h3 id="_l_8217_exportation_des_clients_de_jacinthe_vers_sage">L&#8217;exportation des clients de Jacinthe vers
        Sage</h3>

    <div style="clear:left"></div>
    <div class="paragraph"><p>Elle fait intervenir les sous-dossiers <tt>ClientSage</tt> des dossiers <tt>TR_J</tt>,
        <tt>TR_S</tt> et <tt>TR_A</tt>.</p></div>
<h4 id="_fonctionnement">Fonctionnement</h4>
<div class="paragraph"><p><strong>Première phase : côté Jacinthe</strong></p></div>
    <div class="paragraph"><p>Elle est déclenchée par la commande <em>Exporter les clients</em> du manageur, c&#8217;est-à-dire
        <tt>batman ge</tt>
        (ge pour Gescom export).</p></div>
<div class="paragraph"><p>Cela se fait en plusieurs étapes :</p></div>
    <div class="ulist">
        <ul>
            <li>
                <p>
                    production d&#8217;un fichier de nouveaux clients, aux normes de Windows,
                    nommé <tt>ClientSage-&lt;date&gt;.txt</tt>, où &lt;date&gt; est un tampon de la forme
                    YYYYMMDD-HHMMSS,
                    par exemple 20131104-171324 pour un fichier produit le 4 décembre 2013 à 17h 13m 14s,
                </p>
            </li>
            <li>
                <p>
                    écriture de ce fichier dans le dossier <tt>TR_J/ClientSage</tt> et d&#8217;une copie dans son
                    sous-dossier <tt>Archives</tt>,
                </p>
            </li>
            <li>
                <p>
                    dès lors, le moniteur affiche la présence de ce fichier dans la zone ad-hoc, qui devient jaune,
                </p>
            </li>
            <li>
                <p>
                    dépôt du fichier dans <tt>TR_S/ClientSage</tt>.
                </p>
            </li>
        </ul>
    </div>
<div class="paragraph"><p><strong>Deuxième phase : côté Sage</strong></p></div>
<div class="paragraph"><p>Deux actions à effectuer successivement :</p></div>
    <div class="ulist">
        <ul>
            <li>
                <p>
                    lecture du fichier reçu à l&#8217;aide du format prévu,
                </p>
            </li>
            <li>
                <p>
                    lancement de l&#8217;utilitaire ???????.bat.
                </p>
            </li>
        </ul>
    </div>
    <div class="paragraph"><p>Cet utilitaire fait deux choses : d&#8217;une part retirer le fichier du dossier <tt>TR_S/Client_Sage</tt>
        et l&#8217;archiver dans le sous-dossier <tt>Archives</tt>, d&#8217;autre part le réexpédier vers la SMF
        dans le dossier <tt>TR_A/ClientSage</tt>.</p></div>
<div class="paragraph"><p><strong>Troisième étape, automatique côté Jacinthe</strong></p></div>
<div class="paragraph"><p>Jacinthe (le manageur) constate le retour du fichier, ce qui atteste qu&#8217;il a été lu.
    La copie conservée dans <tt>TR_J/ClientSage</tt> est effacée, le dossier redevient vide et la
    zone d&#8217;affichage du moniteur redevient verte.</p></div>
<div class="admonitionblock">
    <table>
        <tr>
            <td class="icon">
                <div class="title">Note</div>
            </td>
            <td class="content">
                <div class="paragraph"><p>(Note pour moi : le nettoyage des fichiers clients est lancé par le manageur,
                    lorsqu&#8217;il renseigne le nombre de fichiers clients en suspens, donc ne se produit que
                    lorsque le manageur est en action.)</p></div>
                <div class="paragraph"><p>(Note pour moi : les fichiers revenus s&#8217;empilent dans TR_A, il faut
                    aussi les effacer).</p></div>
            </td>
        </tr>
    </table>
</div>
<h4 id="_s_curit">Sécurité</h4>
<div class="paragraph"><p>Ce mécanisme de renvoi du fichier lu vers la SMF a la fonction suivante.</p></div>
    <div class="paragraph"><p>Il se peut que la première phase avorte, parce que la transmission de Jacinthe à Sage n&#8217;a
        pas lieu,
        à cause par exemple d&#8217;une panne de réseau ou de l&#8217;indisponibilité du serveur de Sage.
        La situation est alors désagréable, car le fichier a été produit, de sorte que les clients
        qu&#8217;il contient ont été marqués comme <em>anciens</em> dans la base de Jacinthe.
        Si on relance l&#8217;opération d&#8217;exportation, Jacinthe dira qu&#8217;il n&#8217;y a pas de nouveaux
        clients.</p></div>
    <div class="paragraph"><p>Le fait que le dossier <tt>TR_J/ClientSage</tt> est vide certifie que la transmission a
        bien eu lieu
        (et aussi d&#8217;ailleurs que la lecture côté Sage a eu lieu).
        Si le dossier n&#8217;est pas vide, il faut donc, non pas recommencer l&#8217;exportation, comme on l&#8217;a
        vu,
        mais envoyer à nouveau son contenu.
        Cela se fait par la commande <tt>batman gr</tt> (<strong>gr</strong> pour Gescom Ré-envoyer)</p></div>
    <div class="paragraph"><p>Nota : si deux fichiers sont présents dans le dossier, cela signifie que l&#8217;exportation
        précédente a raté,
        ou bien que le fichier envoyé la fois précédente n&#8217;a pas été lu, et la zone du moniteur devient rouge.</p>
    </div>
    <h3 id="_l_8217_importation_des_ventes_dans_jacinthe_depuis_sage">L&#8217;importation des ventes dans Jacinthe
        depuis Sage.</h3>

    <div style="clear:left"></div>
    <div class="paragraph"><p>Elle fait intervenir les sous-dossiers DocVente des dossiers <tt>TR_J</tt> et
        <tt>TR_A</tt>.</p></div>
<h4 id="_fonctionnement_2">Fonctionnement</h4>
<div class="paragraph"><p><strong>Première phase : côté Sage</strong></p></div>
<div class="paragraph"><p>Là aussi, deux actions à effectuer successivement :</p></div>
    <div class="ulist">
        <ul>
            <li>
                <p>
                    écriture du fichier des ventes à l&#8217;aide du format prévu dans le dossier <tt>TR_S/DocVente</tt>,
                    sous le nom <tt>Ventes.slk</tt>
                </p>
            </li>
            <li>
                <p>
                    lancement de l&#8217;utilitaire ??????.bat, qui ????envoie/copie???? ce fichier dans le dossier <tt>TR_A/DocVente</tt>
                    à la SMF.
                </p>
            </li>
        </ul>
    </div>
<div class="paragraph"><p><strong>Deuxième phase, automatique côté Jacinthe</strong></p></div>
<div class="paragraph"><p>Jacinthe (le manageur) constate l&#8217;arrivée du fichier, ou plutôt constate que le fichier
    <tt>Ventes.slk</tt> est nouveau. En effet, il y a toujours un fichier <tt>Ventes.slk</tt> dans
    <tt>TR_S/DocVente</tt>
    et dans <tt>TR_A/DocVente</tt>, chaque écriture ou transfert écrasant le fichier précédent.
    L'âge du fichier <tt>Ventes.slk</tt> de <tt>TR_A/DocVente</tt>, qui est affiché dans la zone ad-hoc, devient 0 et la
    zone devient (ou reste) verte.</p></div>
    <div class="paragraph"><p>Démarre alors une longue suite d&#8217;opérations, comme le montre le code</p></div>
    <div class="listingblock">
        <div class="content">
<pre><tt>def Sales.import_sales
    fetch_aspaway_file <b>&lt;1&gt;</b>
    build_global_csv_file <b>&lt;2&gt;</b>
    run_patch <b>&lt;3&gt;</b>
    extract_and_load_csv_files <b>&lt;4&gt;</b>
    inject_in_database <b>&lt;5&gt;</b>
    check_remaining_sales <b>&lt;6&gt;</b>
    end</tt></pre>
        </div>
    </div>
    <div class="colist arabic">
        <ol>
            <li>
                <p>
                    Le fichier <tt>Ventes.slk</tt> est copié dans <tt>TR_J/DocVente</tt> depuis <tt>TR_A/DocVente</tt>,
                    écrasant le précédent.
                </p>
            </li>
            <li>
                <p>
                    Il est transformé, de Windows à utf-8 et de SYLK à CSV. Le fichier obtenu, <tt>Ventes.csv</tt>,
                    est aussi rangé dans <tt>TR_J/DocVente</tt>, écrasant le précédent.
                </p>
            </li>
            <li>
                <p>
                    On modifie quelques lignes du fichier, voir plus loin.
                </p>
            </li>
            <li>
                <p>
                    Trois fichiers CSV en sont extraits, correspondant respectivement aux adhésions
                    et abonnements, aux dons, et aux monographies. Ces fichiers sont datés et archivés dans le
                    sous-dossier <tt>TR_J/DocVente/Archives</tt>. Ces trois fichiers sont lus par des procédures
                    <tt>sql</tt> et chaque ligne donne naissance
                    à un enregistrement de la table <tt>sage_document</tt> de Jacinthe DB.
                </p>
            </li>
            <li>
                <p>
                    Ces <tt>sage_document</tt> sont alors injectés dans les tables principales de Jacinthe
                    (abonnements, adhésions variées, etc.). Les documents erronés ne sont pas injectés
                    et marqués comme non importés.
                </p>
            </li>
            <li>
                <p>
                    Une liste des anomalies est produite et enregistrée dans un fichier.
                    Leur nombre est affiché par le manageur. La lecture de ce fichier permet d&#8217;identifier les
                    opérations de Sage à l&#8217;origine des anomalies.
                </p>
            </li>
        </ol>
    </div>
    <div class="paragraph"><p>On notera que jusque-l'étape &lt;4&gt; comprise, et en dehors de données inintéressantes,
        la chose est essentiellement bijective :
        chaque ligne utile d&#8217;une écriture de Sage est reflétée dans un <tt>sage_document</tt>.</p></div>
    <div class="paragraph"><p><strong>Remarques importantes sur les anomalies</strong></p></div>
    <div class="ulist">
        <ul>
            <li>
                <p>
                    Les anomalies principales résultent des contraintes internes de Jacinthe.
                    Par exemple, Jacinthe interdit d&#8217;effacer un client dont les factures ne sont pas soldées,
                    mais cela bloque l&#8217;introduction d&#8217;une facture lorsque le client est inconnu de Jacinthe
                    ;
                    la chose se règlera d&#8217;elle-même lorsque le client aura été créé dans Jacinthe.
                </p>
            </li>
            <li>
                <p>
                    Il est &#171;&#160;normal&#160;&#187; que l&#8217;importation de la vente d&#8217;une cotisation à
                    un tiers se traduise par
                    le marquage pour exportation des clients correspondants.
                    Ce mécanisme de Jacinthe assure en effet que ces tiers bénéficieront
                    bien du tarif réservé aux membres.
                </p>
            </li>
        </ul>
    </div>
    <div class="admonitionblock">
        <table>
            <tr>
                <td class="icon">
                    <div class="title">Note</div>
                </td>
                <td class="content">
                    <div class="title">Le patch</div>
                    <div class="paragraph"><p>Dans l'étape &lt;3&gt;, on corrige des anomalies des factures de la base
                        Gescom (base non modifiable à cause des normes comptables). Par exemple, on renomme des produits
                        dont le code ne respectait pas les conventions de Jacinthe, ce qui empêchait l&#8217;importation
                        des <tt>sage_document</tt> correspondants.</p></div>
                </td>
            </tr>
        </table>
</div>
    <h4 id="_s_curit_2">Sécurité</h4>

    <div class="paragraph"><p>Contrairement au cas des clients, comme chaque fichier envoyé contient toutes les
        opérations (depuis une date de référence). En cas de non-réussite du transfert, il suffit de recommencer.</p>
    </div>
    <h3 id="_l_8217_importation_des_quatre_fichiers_de_production_du_catalogue">L&#8217;importation des quatre fichiers
        de production du catalogue</h3>

    <div style="clear:left"></div>
    <div class="paragraph"><p>Le mécanisme est identique au précédent. Le manageur du catalogue détecte les fichiers
        importés nouveaux et lance leur conversion.</p></div>
    <div class="admonitionblock">
        <table>
            <tr>
                <td class="icon">
                    <div class="title">Note</div>
                </td>
                <td class="content">
                    <div class="title">Archivage</div>
                    <div class="paragraph"><p>La situation actuelle en terme d&#8217;archivage est incohérente.</p>
                    </div>
                    <div class="ulist">
                        <ul>
                            <li>
                                <p>
                                    On archive les dumps journaliers de la base, ce qui donne des fichiers nombreux (365
                                    par an) et énormes.
                                </p>
                            </li>
                            <li>
                                <p>
                                    On archive les fichiers clients transmis, ce qui est "raisonnable" : ils sont petits
                                    et "nouveaux".
                                </p>
                            </li>
                            <li>
                                <p>
                                    On archive les fichiers d&#8217;importations spécialisés d&#8217;importation de
                                    vente,
                                    qui sont gros et se contiennent les uns les autres.
                                </p>
                            </li>
                            <li>
                                <p>
                                    Du côté des transmissions avec Drupal et smf-4, aucun archivage ni dans un sens ni
                                    dans l&#8217;autre.
                                </p>
                            </li>
                        </ul>
                    </div>
                    <div class="paragraph"><p>Je me suis contenté de reproduire ce que Kenji avait fait.
                        Kenji, interrogé, m&#8217;a dit qu&#8217;il avait créé la plupart de ces archivages lors de
                        difficultés
                        de mise au point des programmes. Il nous faut définir les besoins et les stratégies de
                        rétention.</p></div>
                </td>
            </tr>
        </table>
</div>
</div>
    <h2 id="_le_gem_tt_jacman_qt_tt">Le gem <tt>jacman-qt</tt></h2>

    <div class="sectionbody">
        <div class="listingblock">
            <div class="content">
<pre><tt>Files: 19
    Modules: 4
    Classes: 16
    Constants: 38
    Methods: 136</tt></pre>
            </div>
        </div>
        <div class="paragraph"><p>Il fournit tous les outils graphiques d&#8217;interface, soit :</p></div>
        <div class="ulist">
            <ul>
                <li>
                    <p>
                        Le <strong>moniteur</strong>, outil journalier de surveillance et de gestion.
                    </p>
                </li>
                <li>
                    <p>
                        Le <strong>manageur du catalogue</strong>, outil de production d&#8217;un fichier CSV servant de
                        base à la production du catalogue papier annuel.
                    </p>
                </li>
                <li>
                    <p>
                        Le <strong>notificateur</strong>, permettant d&#8217;envoyer les mails de notifications des
                        abonnements électroniques.
                    </p>
                </li>
                <li>
                    <p>
                        Le <strong>manageur SQL</strong>, permettant de gérer la bibliothèque de commandes SQL (celles
                        utilisées en interne par le gem <tt>jacman-core</tt>, mais aussi des commandes ad-hoc) et d&#8217;exécuter
                        ces commandes.
                    </p>
                </li>
            </ul>
        </div>
        <h3 id="moniteur">Le moniteur</h3>

        <div style="clear:left"></div>
        <div class="paragraph"><p>Il assure trois fonctions :</p></div>
        <h4 id="surveillance">La surveillance des opérations automatiques.</h4>

        <div class="paragraph"><p>Voici l&#8217;aide affichée par le manager :</p></div>
        <div class="listingblock">
            <div class="content">
<pre><tt>Cette zone est consacrée à la surveillance des opérations exécutées
    automatiquement par le serveur, les cinq premières chaque nuit, la
    dernière à chaque écriture du fichier des ventes.

    Normalement, les cinq premiers indicateurs doivent être verts,
    le dernier vert ou jaune.

    Un indicateur jaune signale que l'opération n'a pas été exécutée dans
    les dernières 24 heures, un indicateur rouge qu'il y a eu une erreur.
    Dans ces deux cas, merci de prévenir le gestionnaire du serveur.</tt></pre>
            </div>
        </div>
        <div class="paragraph"><p>Les cinq commandes automatiques nocturnes sont :</p></div>
        <div class="ulist">
            <ul>
                <li>
                    <p>
                        <tt>di</tt> : Importer les informations depuis <strong>drupal</strong>.
                    </p>
                </li>
                <li>
                    <p>
                        <tt>de</tt> : Exporter les informations vers <strong>drupal</strong>.
                    </p>
                </li>
                <li>
                    <p>
                        <tt>ea</tt> : Exporter des abonnements électroniques vers <strong>smf4</strong>.
                    </p>
                </li>
                <li>
                    <p>
                        <tt>ep</tt> : Exporter les plages IP vers <strong>smf4</strong>.
                    </p>
                </li>
                <li>
                    <p>
                        <tt>jtd</tt> : Dump total de la base.
                    </p>
                </li>
            </ul>
        </div>
        <h4 id="_la_surveillance_des_op_rations_de_gestion_de_jacinthe_en_cours_en_attente_ou_faire">La surveillance des
            opérations de gestion de Jacinthe en cours, en attente, ou à faire.</h4>

        <div class="paragraph"><p>Voici l&#8217;aide :</p></div>
        <div class="listingblock">
            <div class="content">
<pre><tt>Cette zone est consacrée à la surveillance des diverses opérations de gestion.

    Le code de couleur est le suivant :
    - vert : rien à faire, rien d'anormal.
    - jaune : il y quelque chose à faire
    le cas échéant, un fichier d'anomalie est consultable
    - rouge : retard anormal (pour l'écriture du fichier des ventes).

    Les diverses opérations sont :
    - Importation des ventes : date de la dernière importation (automatique)
    - Fichier des ventes : date de la dernière écriture par Gescom.
    - Ventes non importées : lors de la dernière importation.
    - Fichier client : présence d'un fichier 'ClientSage'
    exporté par Jacinthe et non revenu de Gescom.
    - Clients à exporter : présence dans la base de clients nouveaux ou modifiés.</tt></pre>
            </div>
        </div>
        <h4 id="_les_commandes">Les commandes.</h4>

        <div class="paragraph"><p>Le troisième zone du manageur est consacrée aux commandes (volontaires).
            Ce sont les cinq commandes <tt>de</tt>, <tt>di</tt>, <tt>ge</tt>, <tt>ep</tt>, <tt>ea</tt>.
            Cela couvre toutes les commandes de batman, à l&#8217;exception de :</p></div>
        <div class="ulist">
            <ul>
                <li>
                    <p>
                        la commande <tt>gi</tt> d&#8217;importation des ventes qui est <em>automatique</em> comme on
                        vient de l&#8217;expliquer et qui peut être appelée en urgence par un bouton dans la zone de
                        statut.
                    </p>
                </li>
                <li>
                    <p>
                        les commandes de catalogue, auxquelles le manageur du catalogue est consacré,
                    </p>
                </li>
            </ul>
        </div>
        <div class="paragraph"><p>Notons que les boutons des commandes ne sont actifs que lorsque leur
            utilisation a un sens (par exemple <tt>ge</tt> s&#8217;il y a des nouveaux clients).</p></div>
        <h3 id="catalog">Le manageur du catalogue</h3>

        <div style="clear:left"></div>
        <h4 id="_le_catalogue_interne_de_jacinthe">Le catalogue interne de Jacinthe</h4>

        <div class="paragraph"><p>Voici ce qu&#8217;en dit l&#8217;aide :</p></div>
        <div class="listingblock">
            <div class="content">
<pre><tt>Une base de données nommée +catalogue+ permet d'afficher plus aisément les prix
    et les articles de Sage. Cette base ne sert pas à gérer les prix et les stocks.
    Elle sert uniquement à pouvoir accéder à ces données sous la forme d'un fichier
    OpenOffice Calc ou via le language SQL.

    Les données contenues dans cette base ne se mettent pas à jour automatiquement.
    Il faut donc alimenter cette base régulièrement afin que ses données soient
    synchrones avec celles de Sage Gescom.

    Pour ce faire, on doit mettre à jour séparément les quatre éléments :
    articles, nomenclature, tarifs et stocks.
    Chacune des ces exportations se trouve expliquée dans l'aide correspondante.

    Chacune des quatre exportations de Gescom déclenche automatiquement
    l'importation correspondante et la mise à jour du catalogue.

    Pour l'utilisation dudit catalogue, on se réferera à l'aide spécifique.</tt></pre>
            </div>
        </div>
        <div class="paragraph"><p>Voici cette aide spécifique :</p></div>
        <div class="listingblock">
            <div class="content">
<pre><tt>La base catalogue ne donne que le prix, le stock et la composition des articles en vente.
    Une autre base de données existe sur le serveur smf4.emath.fr, elle aussi nommée catalogue.
    Cette dernière sert au site de vente en ligne, au contenu scientifique des ouvrages, etc.

    On peut récuper et utiliser les données du catalogue de deux façons :

    1. Via un fichier OpenOffice Calc
    Vous devez injecter les données de la vue catalogue interne et/ou catalogue public
    dans un fichier openoffice. Pour cela , prenez la table catalogue.catalogue_interne
    ou catalogue.catalogue_public depuis la source de données Jacinthe.

    2. Via un fichier csv
    Le fichier SMF_SERVEUR/Data/catalogue.csv est mis à jour automatiquement à partir
    de la base de données catalogue. Ce fichier contient les références des articles
    (la nomenclature), la désignation, le prix et le stock.
    Les données sont séparées par des tabulations. Ce fichier peut-être utilisé pour
    injecter des données dans un autre composant du système d'information.</tt></pre>
            </div>
        </div>
        <div class="paragraph"><p>Le manageur du catalogue assure les deux fonctions :</p></div>
        <div class="ulist">
            <ul>
                <li>
                    <p>
                        surveillance de la date des dernières exportations de <tt>Gescom</tt>,
                    </p>
                </li>
                <li>
                    <p>
                        automatisation et surveillance des importation dans la base <tt>catalogue</tt> et exportation du
                        fichier <tt>csv</tt>.
                    </p>
                </li>
            </ul>
        </div>
<div class="admonitionblock">
    <table>
        <tr>
            <td class="icon">
                <div class="title">Note</div>
            </td>
            <td class="content">
                <div class="title">Le problème de(s) catalogue(s)</div>
                <div class="paragraph"><p>A la lecture de l&#8217;aide ci-dessus, on perçoit bien le problème posé par
                    la coexistence de
                    catalogues non synchronisés.</p></div>
            </td>
        </tr>
    </table>
</div>
</div>
</div>
<div id="footnotes">
    <hr/>
</div>
<div id="footer">
    <div id="footer-text">
        Version 3.0<br/>
        Last updated 2015-02-06 12:08:28 Paris, Madrid (heure d’été)
    </div>
</div>
</body>
</html>
